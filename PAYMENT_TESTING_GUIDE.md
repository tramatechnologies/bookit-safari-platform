# Payment System Testing Guide\n\n## Quick Test Workflow\n\n### 1. Setup\n```\n1. Login to the app\n2. Search for and select a bus route\n3. Select seats and passenger details\n4. Complete booking form\n5. Navigate to payment page\n```\n\n### 2. Test Cases\n\n#### âœ… Test 1: Successful Payment\n**Steps:**\n1. Select payment method: M-Pesa\n2. Enter phone number: +255712345678\n3. Click \"Pay [Amount]\"\n4. **Expected:** \n   - Toast: \"Payment Request Sent\"\n   - Page shows loading state\n   - Polling starts (check browser Network tab)\n   - After 30-60 seconds: Success page\n   - Redirects to confirmation\n\n**Database Verification:**\n```sql\n-- Check payment record\nSELECT * FROM payments WHERE booking_id = '[booking_id]';\n-- Should show: status = 'completed'\n\n-- Check booking record\nSELECT * FROM bookings WHERE id = '[booking_id]';\n-- Should show: status = 'confirmed'\n```\n\n#### âŒ Test 2: Failed Payment\n**Steps:**\n1. Select payment method: Tigopesa\n2. Enter phone number: +255712345678\n3. Click \"Pay [Amount]\"\n4. **Expected:** \n   - Toast: \"Payment Request Sent\"\n   - After waiting: Error message appears\n   - Button changes to \"Retry Payment\"\n5. Click \"Retry Payment\"\n6. **Expected:** Form resets, can try different method\n\n**Database Verification:**\n```sql\n-- Check payment status\nSELECT * FROM payments WHERE booking_id = '[booking_id]' ORDER BY created_at DESC LIMIT 1;\n-- Should show: status = 'failed'\n```\n\n#### â±ï¸ Test 3: Polling Timeout\n**Steps:**\n1. Select payment method: Airtel\n2. Enter phone number: +255712345678\n3. Click \"Pay [Amount]\"\n4. **Don't enter PIN on phone**\n5. Wait 5+ minutes\n6. **Expected:**\n   - Polling stops\n   - Shows: \"Payment pending\" message\n   - Suggests checking email\n   - Button available for retry\n\n**What's Happening:**\n- Exponential backoff continues polling\n- After 5 minutes (300 seconds), polling stops\n- Booking remains in `pending` state\n- User can retry later\n\n#### ðŸ”„ Test 4: Retry After Failure\n**Steps:**\n1. Complete Test 2 (failed payment)\n2. Payment shows failed state\n3. Change payment method to different provider\n4. Click \"Retry Payment\"\n5. **Expected:**\n   - Form resets\n   - Polling restarts\n   - Old payment record updated with new method\n\n**Database Check:**\n```sql\n-- Check payment history\nSELECT id, status, payment_method, created_at, updated_at \nFROM payments \nWHERE booking_id = '[booking_id]' \nORDER BY updated_at DESC;\n-- Should show attempts with different payment_methods\n```\n\n#### ðŸŒ Test 5: Network Error Handling\n**Steps:**\n1. Open DevTools (F12)\n2. Go to Network tab\n3. Right-click â†’ Throttle â†’ Offline\n4. Select payment method: M-Pesa\n5. Click \"Pay [Amount]\"\n6. **Expected:**\n   - Error toast appears immediately\n   - Message includes: \"Check your internet connection\"\n   - Button ready for retry\n7. Go back online\n8. Click \"Retry Payment\"\n9. **Expected:** Payment now succeeds\n\n#### ðŸ“± Test 6: Phone Number Validation\n**Steps:**\n1. Select payment method: M-Pesa\n2. Try invalid phone numbers:\n   - \"invalid\"\n   - \"123\"\n   - \"+999999999999\"\n3. Click \"Pay [Amount]\"\n4. **Expected:**\n   - Validation error toast\n   - Message suggests checking format\n   - Form remains open for correction\n\n#### ðŸ” Test 7: Authorization Check\n**Steps:**\n1. Logout\n2. Go directly to payment URL: `/payment/[booking_id]`\n3. **Expected:**\n   - Redirected to login\n   - Cannot access payment without auth\n\n#### ðŸ’° Test 8: Amount Validation\n**Database Direct Test:**\n```sql\n-- Create test payment with wrong amount\nINSERT INTO payments (booking_id, amount_tzs, status, payment_method)\nVALUES ('[booking_id]', 1000, 'pending', 'clickpesa');\n\n-- Webhook would receive: 50000 TZS\n-- Expected: Rejected (amount mismatch)\n```\n\n## Polling Behavior Verification\n\n### Browser Console Logs\nOpen DevTools â†’ Console and look for:\n```\nâœ“ First poll immediately\nâœ“ Intervals: 2s, 2s, 3s, 4s, 5s, 7s, 10s, 10s...\nâœ“ Success detected within 60-120 seconds normally\nâœ“ Error states trigger immediate stop\n```\n\n### Network Tab\n1. Open DevTools â†’ Network\n2. Click \"Pay\"\n3. Look for requests:\n   - `POST initiate-payment` - Initial payment request\n   - Multiple `GET bookings` - Polling requests\n   - Pattern: 2s â†’ 3s â†’ 4s â†’ 5s (exponential backoff)\n\n### Console Commands\n```javascript\n// In browser console while polling\n\n// Check current polling state\nwindow.paymentPollingActive // true/false\n\n// View recent payments\nawait supabase\n  .from('payments')\n  .select('*')\n  .order('created_at', { ascending: false })\n  .limit(5)\n  .then(r => console.table(r.data))\n\n// Check booking status\nawait supabase\n  .from('bookings')\n  .select('id, status, reference')\n  .eq('id', '[booking_id]')\n  .then(r => console.log(r.data[0]))\n```\n\n## Webhook Testing\n\n### Test Manual Webhook\n```bash\ncurl -X POST https://udiiniltuufkxivguayd.supabase.co/functions/v1/webhook-clickpesa-callback \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"event\": \"PAYMENT_RECEIVED\",\n    \"order_reference\": \"[booking_id]\",\n    \"transaction_id\": \"TXN123456\",\n    \"amount\": 50000,\n    \"currency\": \"TZS\",\n    \"timestamp\": \"2026-01-03T15:00:00Z\"\n  }'\n```\n\n### Check Webhook Logs\nSupabase Dashboard â†’ Edge Functions â†’ webhook-clickpesa-callback â†’ Logs\n\nLook for:\n```\n[webhook] Received event: PAYMENT_RECEIVED for order: [booking_id]\n[payment-received] Processing: [booking_id]\n[payment-received] Confirmation email sent for booking: [booking_id]\n```\n\n## Common Issues & Fixes\n\n### Issue: Polling never completes\n**Causes:**\n- Booking status not updating\n- Payment webhook not received\n- Database query error\n\n**Fix:**\n1. Check booking status: `SELECT status FROM bookings WHERE id = '[id]'`\n2. Check payment status: `SELECT status FROM payments WHERE booking_id = '[id]'`\n3. Check function logs for errors\n4. Verify webhook URL in ClickPesa dashboard\n\n### Issue: \"Payment pending\" after 5 minutes\n**Expected Behavior:**\n- This is correct - polling timeout is 5 minutes\n- User should check email for confirmation\n- Payment may still be processing at provider\n\n**What to do:**\n1. Check booking status in database\n2. Check if webhook arrived (look at `payment_data.webhook_timestamp`)\n3. User can refresh page to check status\n4. Check payment email notifications\n\n### Issue: Multiple payment records for same booking\n**Expected Behavior:**\n- When user retries, updates same pending payment\n- Only one `pending` payment per booking at a time\n\n**Fix:**\n1. Check: `SELECT * FROM payments WHERE booking_id = '[id]'`\n2. Should see one `pending` record, others are `failed` or `completed`\n3. If multiple pending, webhook may have issues\n\n## Performance Monitoring\n\n### Polling Load Test\n1. Initiate 10 payments simultaneously\n2. Monitor browser: CPU/Memory usage\n3. Expected: Minimal impact due to exponential backoff\n4. Check server logs: Should see pattern of declining frequency\n\n### Database Load\n1. Monitor: Bookings table queries per second\n2. Expected: Decreasing from ~5 req/s â†’ ~0.5 req/s after 30s\n3. Check: Query execution time (should be <100ms)\n\n## Success Criteria\n\nâœ… All tests pass â†’ Payment system is production ready\n\n- [ ] Test 1: Successful payment works\n- [ ] Test 2: Failed payment handled gracefully  \n- [ ] Test 3: Timeout handled correctly\n- [ ] Test 4: Retry mechanism works\n- [ ] Test 5: Network errors show helpful messages\n- [ ] Test 6: Validation prevents invalid inputs\n- [ ] Test 7: Authorization enforced\n- [ ] Test 8: Amount validation works\n- [ ] Polling follows exponential backoff\n- [ ] Webhook processing completes quickly\n- [ ] Emails arrive (check spam folder)\n- [ ] Performance acceptable with concurrent payments\n"